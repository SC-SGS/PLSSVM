#!groovy
pipeline {
    agent { label 'pcsgs02 || pcsgs03 || pcsgs04 || pcsgs05' }
    environment {
        GITLAB_TOKEN = credentials('PLSSVM-GitLab-Api')
    }
    stages {
        stage('init') {
            steps {
                dir('plssvm') {
                    sh '''
                        gitlab_token=$(echo ${GITLAB_TOKEN} | cut -f2 -d':')
                        curl --verbose\
                            --request POST \
                            --url "https://gitlab-sim.informatik.uni-stuttgart.de/api/v4/projects/162/statuses/$GIT_COMMIT" \
                            --header "Content-Type: application/json" \
                            --header "authorization: Bearer ${gitlab_token}" \
                            --data "{
                                \\"state\\": \\"running\\",
                                \\"context\\": \\"jenkins-ctest\\",
                                \\"description\\": \\"Jenkins CI Job: jenkins-ctest\\",
                                \\"target_url\\": \\"https://simsgs.informatik.uni-stuttgart.de/jenkins/view/All/job/PLSSVM/job/PLSSVM-test/$BUILD_NUMBER\\"
                        }"
                    '''
                }
            }
        }
        stage('checkout') {
            steps {
                dir('plssvm') {
                    checkout scm
                }
            }
        }
        stage('setup python'){
            steps{
                sh '''
                    /usr/bin/python3.8 -m pip install --user arff
                    /usr/bin/python3.8 -m pip install --user pandas
                    /usr/bin/python3.8 -m pip install --user sklearn
                    /usr/bin/python3.8 -m pip install --user argparse
                '''
            }
        }
        stage('build plssvm Release') {
            steps {
                dir('plssvm') {
                    sh '''
                        module load cuda
                        cd SVM
                        mkdir -p build/Release
                        cd build/Release
                        rm -rf *
                        /import/sgs.scratch/vancraar/spack/opt/spack/linux-ubuntu20.04-cascadelake/clang-12.0.0/cmake-3.20.2-z3urlvzqm5igtwxj25nnd5olciuq7ayb/bin/cmake -DCMAKE_BUILD_TYPE=Release -DPLSSVM_TARGET_PLATFORMS="cpu;nvidia:sm_86" -DPLSSVM_ENABLE_ASSERTS=ON ../../
                        make -j4
                    '''
                }
            }
        }
        stage('run tests Release') {
            steps {
                dir('plssvm') {
                    warnError('Release tests failed!') {
                        sh '''
                            module load cuda
                            cd SVM/build/Release
                            ctest -j4 --no-compress-output -T Test
                        '''
                    }
                }
            }
        }
        stage('build plssvm hipSYCL Release') {
            steps {
                dir('plssvm') {
                    sh '''
                        module load cuda
                        module use /home/breyerml/.modulefiles/
                        module load pcsgs05/hipsycl
                        cd SVM
                        mkdir -p build/Release_hip
                        cd build/Release_hip
                        rm -rf *
                        /import/sgs.scratch/vancraar/spack/opt/spack/linux-ubuntu20.04-cascadelake/clang-12.0.0/cmake-3.20.2-z3urlvzqm5igtwxj25nnd5olciuq7ayb/bin/cmake -DCMAKE_BUILD_TYPE=Release -DPLSSVM_TARGET_PLATFORMS="cpu;nvidia:sm_80" -DPLSSVM_ENABLE_OPENMP_BACKEND=OFF -DPLSSVM_ENABLE_CUDA_BACKEND=OFF -DPLSSVM_ENABLE_OPENCL_BACKEND=OFF -DPLSSVM_ENABLE_SYCL_BACKEND=ON -DPLSSVM_ENABLE_ASSERTS=ON ../../
                        make -j4
                    '''
                }
            }
        }
        stage('run tests hipSYCL Release') {
            steps {
                dir('plssvm') {
                    warnError('hipSYCL Release tests failed!') {
                        sh '''
                            module load cuda
                            module use /home/breyerml/.modulefiles/
                            module load pcsgs05/hipsycl
                            cd SVM/build/Release_hip
                            ctest -j4 --no-compress-output -T Test
                        '''
                    }
                }
            }
        }
        stage('build plssvm DPC++ Release') {
            steps {
                dir('plssvm') {
                    sh '''
                        module load cuda
                        module use /home/breyerml/.modulefiles/
                        module load pcsgs05/dpcpp_rt
                        cd SVM
                        mkdir -p build/Release_dpcpp
                        cd build/Release_dpcpp
                        rm -rf *
                        /import/sgs.scratch/vancraar/spack/opt/spack/linux-ubuntu20.04-cascadelake/clang-12.0.0/cmake-3.20.2-z3urlvzqm5igtwxj25nnd5olciuq7ayb/bin/cmake -DCMAKE_BUILD_TYPE=Release -DPLSSVM_TARGET_PLATFORMS="cpu;nvidia:sm_80" -DCMAKE_CXX_COMPILER=clang++ -DPLSSVM_ENABLE_OPENMP_BACKEND=OFF -DPLSSVM_ENABLE_CUDA_BACKEND=ON -DPLSSVM_ENABLE_OPENCL_BACKEND=OFF -DPLSSVM_ENABLE_SYCL_BACKEND=ON -DPLSSVM_ENABLE_ASSERTS=ON ../../
                        make -j4
                    '''
                }
            }
        }
        stage('run tests DPC++ Release') {
            steps {
                dir('plssvm') {
                    warnError('DPC++ Release tests failed!') {
                        sh '''
                            module load cuda
                            module use /home/breyerml/.modulefiles/
                            module load pcsgs05/dpcpp_rt
                            cd SVM/build/Release_dpcpp
                            ctest -j4 --no-compress-output -T Test
                        '''
                    }
                }
            }
        }
        stage('build plssvm Debug and coverage analysis') {
            steps {
                dir('plssvm') {
                    sh '''
                        module load cuda
                        cd SVM
                        mkdir -p build/Debug_cov
                        cd build/Debug_cov
                        rm -rf *
                        /import/sgs.scratch/vancraar/spack/opt/spack/linux-ubuntu20.04-cascadelake/clang-12.0.0/cmake-3.20.2-z3urlvzqm5igtwxj25nnd5olciuq7ayb/bin/cmake -DCMAKE_BUILD_TYPE=Coverage -DPLSSVM_TARGET_PLATFORMS="cpu;nvidia:sm_86" -DPLSSVM_TEST_FILE_NUM_DATA_POINTS=100 -DPLSSVM_TEST_FILE_NUM_FEATURES=20 ../../
                        make -j4 coverage
                        wget -N https://raw.githubusercontent.com/eriwen/lcov-to-cobertura-xml/master/lcov_cobertura/lcov_cobertura.py
                        python lcov_cobertura.py test_clean.info
                    '''
                    cobertura coberturaReportFile: 'SVM/build/Debug_cov/coverage.xml'
                }
            }
        }
        stage('build plssvm hipSYCL Debug') {
            steps {
                dir('plssvm') {
                    sh '''
                        module load cuda
                        module use /home/breyerml/.modulefiles/
                        module load pcsgs05/hipsycl
                        cd SVM
                        mkdir -p build/Debug_hip
                        cd build/Debug_hip
                        rm -rf *
                        /import/sgs.scratch/vancraar/spack/opt/spack/linux-ubuntu20.04-cascadelake/clang-12.0.0/cmake-3.20.2-z3urlvzqm5igtwxj25nnd5olciuq7ayb/bin/cmake -DCMAKE_BUILD_TYPE=Debug -DPLSSVM_TARGET_PLATFORMS="cpu;nvidia:sm_80" -DPLSSVM_ENABLE_OPENMP_BACKEND=OFF -DPLSSVM_ENABLE_CUDA_BACKEND=OFF -DPLSSVM_ENABLE_OPENCL_BACKEND=OFF -DPLSSVM_ENABLE_SYCL_BACKEND=ON ../../
                        make -j4
                    '''
                }
            }
        }
        stage('build plssvm DPC++ Debug') {
            steps {
                dir('plssvm') {
                    sh '''
                        module load cuda
                        module use /home/breyerml/.modulefiles/
                        module load pcsgs05/dpcpp_rt
                        cd SVM
                        mkdir -p build/Debug_dpcpp
                        cd build/Debug_dpcpp
                        rm -rf *
                        /import/sgs.scratch/vancraar/spack/opt/spack/linux-ubuntu20.04-cascadelake/clang-12.0.0/cmake-3.20.2-z3urlvzqm5igtwxj25nnd5olciuq7ayb/bin/cmake -DCMAKE_BUILD_TYPE=Debug -DPLSSVM_TARGET_PLATFORMS="cpu;nvidia:sm_80" -DCMAKE_CXX_COMPILER=clang++ -DPLSSVM_ENABLE_OPENMP_BACKEND=OFF -DPLSSVM_ENABLE_CUDA_BACKEND=ON -DPLSSVM_ENABLE_OPENCL_BACKEND=OFF -DPLSSVM_ENABLE_SYCL_BACKEND=ON ../../
                        make -j4
                    '''
                }
            }
        }
    }
    post {
        always {
            // Process the CTest xml output with the xUnit plugin
            xunit (
                testTimeMargin: '3000',
                thresholdMode: 1,
                thresholds: [
                    skipped(failureThreshold: '0'),
                    failed(failureThreshold: '0')
                ],
                tools: [CTest(
                    pattern: 'plssvm/SVM/build/*/Testing/**/*.xml',
                    deleteOutputFiles: true,
                    failIfNotNew: false,
                    skipNoTestFiles: true,
                    stopProcessingIfError: true
                )]
            )

        }
        success {
            sh '''
                gitlab_token=$(echo ${GITLAB_TOKEN} | cut -f2 -d':')
                curl --verbose\
                    --request POST \
                    --url "https://gitlab-sim.informatik.uni-stuttgart.de/api/v4/projects/162/statuses/$GIT_COMMIT" \
                    --header "Content-Type: application/json" \
                    --header "authorization: Bearer ${gitlab_token}" \
                    --data "{
                        \\"state\\": \\"success\\",
                        \\"context\\": \\"jenkins-ctest\\",
                        \\"description\\": \\"Jenkins CI Job: jenkins-ctest\\",
                        \\"target_url\\": \\"https://simsgs.informatik.uni-stuttgart.de/jenkins/view/All/job/PLSSVM/job/PLSSVM-test/$BUILD_NUMBER\\"
                }"
            '''
        }
        failure {
            sh '''
                gitlab_token=$(echo ${GITLAB_TOKEN} | cut -f2 -d':')
                curl --verbose\
                    --request POST \
                    --url "https://gitlab-sim.informatik.uni-stuttgart.de/api/v4/projects/162/statuses/$GIT_COMMIT" \
                    --header "Content-Type: application/json" \
                    --header "authorization: Bearer ${gitlab_token}" \
                    --data "{
                        \\"state\\": \\"failed\\",
                        \\"context\\": \\"jenkins-ctest\\",
                        \\"description\\": \\"Jenkins CI Job: jenkins-ctest\\",
                        \\"target_url\\": \\"https://simsgs.informatik.uni-stuttgart.de/jenkins/view/All/job/PLSSVM/job/PLSSVM-test/$BUILD_NUMBER\\"
                }"
            '''
        }
        aborted {
            sh '''
                gitlab_token=$(echo ${GITLAB_TOKEN} | cut -f2 -d':')
                curl --verbose\
                    --request POST \
                    --url "https://gitlab-sim.informatik.uni-stuttgart.de/api/v4/projects/162/statuses/$GIT_COMMIT" \
                    --header "Content-Type: application/json" \
                    --header "authorization: Bearer ${gitlab_token}" \
                    --data "{
                        \\"state\\": \\"canceled\\",
                        \\"context\\": \\"jenkins-ctest\\",
                        \\"description\\": \\"Jenkins CI Job: jenkins-ctest\\",
                        \\"target_url\\": \\"https://simsgs.informatik.uni-stuttgart.de/jenkins/view/All/job/PLSSVM/job/PLSSVM-test/$BUILD_NUMBER\\"
                }"
            '''
        }
    }
}
