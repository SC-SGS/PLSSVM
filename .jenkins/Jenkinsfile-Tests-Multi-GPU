#!groovy

def buildbadge = addEmbeddableBadgeConfiguration(id: "Jenkins", subject: "Jenkins Tests", status: "skipped")

if (currentBuild.getBuildCauses().toString().contains('BranchIndexingCause')) {
    print "INFO: Build on ${env.BRANCH_NAME}/${env.BUILD_NUMBER}  triggered by branch indexing..."
    if (env.BRANCH_NAME != "master") {
        if (env.BUILD_NUMBER != "1") { // Always execute first build to load this configuration and thus the triggers
            print "INFO: Build on ${env.BRANCH_NAME}/${env.BUILD_NUMBER} skipped due being triggered by Branch Indexing instead of SCM change!"
            buildbadge.setStatus('skipped')
            currentBuild.result = 'ABORTED'
            return // early exit to avoid redundant builds
        }
    }
} else {
    print "INFO: Build on ${env.BRANCH_NAME}/${env.BUILD_NUMBER} triggered by SCM change..."
    print "Proceeding!"
}


pipeline {
    agent { label 'argon-fs'}

    options {
        buildDiscarder(
            logRotator(
                daysToKeepStr: "21",
                numToKeepStr: "50",
                artifactDaysToKeepStr: "21",
                artifactNumToKeepStr: "50"
            )
        )
    }

    triggers {
        githubPush()           // Trigger by push to respective github branch
        pollSCM 'H/15 * * * *' // Fallback polling solution as some pushes are somehow lost
    }

    environment {
        GITHUB_TOKEN = credentials('GITHUB_TOKEN')
        BRANCH_NAME = "${env.BRANCH_NAME}"
        TMPDIR = "/data/argon-fs/sgs/jenkins/tmp"

        // DPCPP
        DPCPP_PATH = "/data/argon-fs/sgs/jenkins/workspace/PLSSVM_Github-Multi-GPU_jenkins/llvm/build"
        DPCPP_FORCE_REBUILD = "FALSE"

        // hipSYCL
        HIPSYCL_PATH = "/data/argon-fs/sgs/jenkins/workspace/PLSSVM_Github-Multi-GPU_jenkins/hipsycl-install"
        HIPSYCL_FORCE_REBUILD = "FALSE"
    }

    stages {
        stage('Pending') {
            steps {
                sh '''
                    gitlab_token=$(echo ${GITHUB_TOKEN} | cut -f2 -d':')
                    curl --verbose\
                         --request POST \
                         --url "https://api.github.com/repos/SC-SGS/PLSSVM/statuses/$GIT_COMMIT" \
                         --header "Content-Type: application/json" \
                         --header "authorization: Bearer ${gitlab_token}" \
                         --data "{
                            \\"state\\": \\"pending\\",
                            \\"context\\": \\"Jenkins Multi-GPU tests\\",
                            \\"description\\": \\"Jenkins CI Job: Jenkins Multi-GPU tests\\",
                            \\"target_url\\": \\"https://simsgs.informatik.uni-stuttgart.de/jenkins/view/PLSSVM/job/PLSSVM/job/Github-Multi-GPU/job/${BRANCH_NAME}/$BUILD_NUMBER\\"
                    }"
                '''
            }
        }

        stage('Checkout PLSSVM') {
            steps {
                sh '''
                    srun -w argon-gtx -N 1 -n 1 -t 0:05:00 -D /scratch bash -c "\
                    cd /scratch && \
                    mkdir -p jenkins && cd jenkins; \
                    mkdir -p plssvm/${BUILD_TAG} && cd plssvm/${BUILD_TAG} && \
                    rm -rf PLSSVM && \
                    git clone git@github.com:SC-SGS/PLSSVM.git PLSSVM && \
                    cd PLSSVM && \
                    pwd && \
                    git checkout ${GIT_COMMIT}"
                '''
                sh '''
                    mkdir ${BUILD_TAG}
                '''
            }
        }

        stage('Installing Dependencies') {
            stages {
                stage('Dependency - Python packages') {
                    steps {
                        sh '''
                            python3 -m pip install --user -r install/python_requirements.txt
                        '''
                    }
                }
                stage('Dependency - test file') {
                    steps {
                        dir('plssvm') {
                            sh '''
                                # generate test file to prevent possible race conditions later on in the pipeline
                                srun -w argon-gtx -N 1 -n 1 -t 00:05:00 -D /scratch/jenkins/plssvm/${BUILD_TAG}/PLSSVM bash -c "\
                                    python3 utility_scripts/generate_data.py --output tests/data/5000x2000.libsvm --format libsvm --problem planes --samples 5000 --features 2000"
                            '''
                        }
                    }
                }
                stage('Dependency - Ninja') {
                    steps {
                        sh '''
                            cd /data/sgs/jenkins/workspace/PLSSVM_Github-Multi-GPU_jenkins
                            if [ ! -f ninja ]; then
                                wget https://github.com/ninja-build/ninja/releases/download/v1.11.1/ninja-linux.zip
                                unzip ninja-linux.zip
                                rm ninja-linux.zip*
                            fi
                        '''
                    }
                }
                stage('Dependency - CMake') {
                    steps {
                        sh '''
                            cd /data/sgs/jenkins/workspace/PLSSVM_Github-Multi-GPU_jenkins
                            if [ ! -d cmake-3.24.1-linux-x86_64 ]; then
                                wget https://github.com/Kitware/CMake/releases/download/v3.24.1/cmake-3.24.1-linux-x86_64.tar.gz
                                tar xvzf cmake-3.24.1-linux-x86_64.tar.gz
                                rm cmake-3.24.1-linux-x86_64.tar.gz*
                            fi
                        '''
                    }
                }
                stage('Dependency - DPC++') {
                    environment {
                        PATH="/data/argon-fs/sgs/jenkins/workspace/PLSSVM_Github-Multi-GPU_jenkins:/data/sgs/jenkins/workspace/PLSSVM_Github-Multi-GPU_jenkins:/data/argon-fs/sgs/jenkins/workspace/PLSSVM_Github-Multi-GPU_jenkins/cmake-3.24.1-linux-x86_64/bin:/data/sgs/jenkins/workspace/PLSSVM_Github-Multi-GPU_jenkins/cmake-3.24.1-linux-x86_64/bin:${env.PATH}"
                    }
                    steps{
                        sh '''
                            srun -w argon-gtx -N 1 -n 1 -t 01:00:00 -D /data/argon-fs/sgs/jenkins/workspace/PLSSVM_Github-Multi-GPU_jenkins bash -c "\
                            module load cuda/11.2.2 &&\
                            if [ ! -d "$DPCPP_PATH" ] || [ "$DPCPP_FORCE_REBUILD" = "TRUE" ]; then \
                                rm -rf llvm && \
                                git clone --dept 1 --branch sycl-nightly/20221102 https://github.com/intel/llvm.git llvm  || true; \
                                cd llvm &&\
                                python buildbot/configure.py --cuda --llvm-external-projects=\"clang-tools-extra,compiler-rt,openmp\" --cmake-opt=\"-DENABLE_LIBOMPTARGET=OFF\" &&\
                                python buildbot/compile.py &&\
                                cmake --build build -- omp &&\
                                cmake --build build -- install &&\
                                rm -rf "$HIPSYCL_PATH"
                            fi"
                        '''
                    }
                }
                stage('Dependency - hipSYCL') {
                    environment {
                        PATH="/data/argon-fs/sgs/jenkins/workspace/PLSSVM_Github-Multi-GPU_jenkins/cmake-3.24.1-linux-x86_64/bin:/data/sgs/jenkins/workspace/PLSSVM_Github-Multi-GPU_jenkins/cmake-3.24.1-linux-x86_64/bin:$DPCPP_PATH/bin:${env.PATH}"
                        LIBRARY_PATH="$DPCPP_PATH/lib:${env.LIBRARY_PATH}"
                        LD_LIBRARY_PATH="$DPCPP_PATH/lib:${env.LD_LIBRARY_PATH}"
                        CPLUS_INCLUDE_PATH="$DPCPP_PATH/install/include/sycl:$DPCPP_PATH/install/include:$DPCPP_PATH/projects/openmp/runtime/src:${env.CPLUS_INCLUDE_PATH}"
                    }
                    steps {
                        sh '''
                            if [ ! -d "$HIPSYCL_PATH" ] || [ "$HIPSYCL_FORCE_REBUILD" = "TRUE" ]; then
                                srun -w argon-gtx -N 1 -n 1 -t 00:05:00 -D /data/argon-fs/sgs/jenkins/workspace/PLSSVM_Github-Multi-GPU_jenkins bash -c "\
                                    rm -rf hipSYCL && \
                                    rm -rf "$HIPSYCL_PATH" && \
                                    module load cuda/11.2.2 && \
                                    mkdir $HIPSYCL_PATH && \
                                    git clone https://github.com/illuhad/hipSYCL.git hipSYCL && \
                                    cd hipSYCL && \
                                    git checkout 012e16d6d3d57330c176d7d536f657b0d8a9a197 && \
                                    mkdir build && \
                                    cd build && \
                                    cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=$HIPSYCL_PATH -DCMAKE_CXX_COMPILER=clang++ .. && \
                                    make -j && \
                                    make install && \
                                    rm -rf hipSYCL "
                            fi
                        '''
                    }
                }
            }
        }


        stage('Multi-GPU') {
            parallel {

                stage('CUDA - Release') {
                    environment {
                        PATH="/data/argon-fs/sgs/jenkins/workspace/PLSSVM_Github-Multi-GPU_jenkins/cmake-3.24.1-linux-x86_64/bin:/data/sgs/jenkins/workspace/PLSSVM_Github-Multi-GPU_jenkins/cmake-3.24.1-linux-x86_64/bin:${env.PATH}"
                    }
                    stages {
                        stage('CUDA - Release - build') {
                            steps {
                                dir('plssvm') {
                                    sh '''
                                        srun -w argon-gtx -N 1 -n 1 -t 00:25:00 -D /scratch/jenkins/plssvm/${BUILD_TAG}/PLSSVM bash -c "\
                                        module load cuda/11.2.2 &&\
                                        mkdir -p build/Release_CUDA &&\
                                        cd build/Release_CUDA &&\
                                        rm -rf * &&\
                                        cmake -DCMAKE_BUILD_TYPE=Release -DPLSSVM_TARGET_PLATFORMS='nvidia:sm_61' -DPLSSVM_ENABLE_ASSERTS=ON -DPLSSVM_ENABLE_OPENMP_BACKEND=OFF -DPLSSVM_ENABLE_SYCL_BACKEND=OFF -DPLSSVM_ENABLE_CUDA_BACKEND=ON -DPLSSVM_ENABLE_HIP_BACKEND=OFF -DPLSSVM_ENABLE_OPENCL_BACKEND=OFF -S ../../ &&\
                                        make -j4"
                                    '''
                                }
                            }
                        }
                        stage('CUDA - Release - test') {
                            steps {
                                dir('plssvm') {
                                    warnError('Release tests failed!') {
                                        sh '''
                                            srun -w argon-gtx -N 1 -n 1 -t 01:00:00 -D /scratch/jenkins/plssvm/${BUILD_TAG}/PLSSVM --gres=gpu:4 bash -c "\
                                            module load cuda/11.2.2 &&\
                                            cd build/Release_CUDA &&\
                                            ctest --output-on-failure -j4 --no-compress-output -T Test --timeout 3600; \
                                            returncode=$? && \
                                            cp -r Testing /data/argon-fs/sgs/jenkins/workspace/$(basename ${WORKSPACE})/${BUILD_TAG}/Testing &&\
                                            exit $returncode"
                                        '''
                                    }
                                }
                            }
                        }
                    }
                } // end CUDA Release

                stage('OpenCL - Release') {
                    environment {
                        PATH="/data/argon-fs/sgs/jenkins/workspace/PLSSVM_Github-Multi-GPU_jenkins/cmake-3.24.1-linux-x86_64/bin:/data/sgs/jenkins/workspace/PLSSVM_Github-Multi-GPU_jenkins/cmake-3.24.1-linux-x86_64/bin:${env.PATH}"
                    }
                    stages {
                        stage('OpenCL - Release - build') {
                            steps {
                                dir('plssvm') {
                                    sh '''
                                        srun -w argon-gtx -N 1 -n 1 -t 00:25:00 -D /scratch/jenkins/plssvm/${BUILD_TAG}/PLSSVM bash -c "\
                                        module load cuda/11.2.2 &&\
                                        mkdir -p build/Release_OpenCL &&\
                                        cd build/Release_OpenCL &&\
                                        rm -rf * &&\
                                        cmake -DCMAKE_BUILD_TYPE=Release -DPLSSVM_TARGET_PLATFORMS='nvidia:sm_61' -DPLSSVM_ENABLE_ASSERTS=ON -DPLSSVM_ENABLE_OPENMP_BACKEND=OFF -DPLSSVM_ENABLE_SYCL_BACKEND=OFF -DPLSSVM_ENABLE_CUDA_BACKEND=OFF -DPLSSVM_ENABLE_HIP_BACKEND=OFF -DPLSSVM_ENABLE_OPENCL_BACKEND=ON -S ../../ &&\
                                        make -j4"
                                    '''
                                }
                            }
                        }
                        stage('OpenCL - Release - test') {
                            steps {
                                dir('plssvm') {
                                    warnError('Release tests failed!') {
                                        sh '''
                                            srun -w argon-gtx -N 1 -n 1 -t 01:00:00 -D /scratch/jenkins/plssvm/${BUILD_TAG}/PLSSVM --gres=gpu:4 bash -c "\
                                            module load cuda/11.2.2 &&\
                                            cd build/Release_OpenCL &&\
                                            ctest --output-on-failure -j4 --no-compress-output -T Test --timeout 3600; \
                                            returncode=$? && \
                                            cp -r Testing /data/argon-fs/sgs/jenkins/workspace/$(basename ${WORKSPACE})/${BUILD_TAG}/Testing &&\
                                            exit $returncode"
                                        '''
                                    }
                                }
                            }
                        }
                    }
                } // end OpenCL Release

                stage('hipSYCL - Release') {
                    environment {
                        PATH="/data/argon-fs/sgs/jenkins/workspace/PLSSVM_Github-Multi-GPU_jenkins/cmake-3.24.1-linux-x86_64/bin:/data/sgs/jenkins/workspace/PLSSVM_Github-Multi-GPU_jenkins/cmake-3.24.1-linux-x86_64/bin:$HIPSYCL_PATH/bin:${env.PATH}"
                        LD_LIBRARY_PATH="$DPCPP_PATH/lib:$HIPSYCL_PATH/lib:${env.LD_LIBRARY_PATH}"
                        CPLUS_INCLUDE_PATH="$DPCPP_PATH/projects/openmp/runtime/src:${env.CPLUS_INCLUDE_PATH}"
                    }
                    stages {
                        stage('hipSYCL - Release - build') {
                            steps {
                                dir('plssvm') {
                                    sh '''
                                        srun -w argon-gtx -N 1 -n 1 -t 00:25:00 -D /scratch/jenkins/plssvm/${BUILD_TAG}/PLSSVM bash -c "\
                                        module load cuda/11.2.2 &&\
                                        mkdir -p build/Release_hipSYCL &&\
                                        cd build/Release_hipSYCL &&\
                                        rm -rf * &&\
                                        cmake -DCMAKE_BUILD_TYPE=Release -DPLSSVM_TARGET_PLATFORMS='nvidia:sm_61' -DPLSSVM_ENABLE_ASSERTS=ON -DPLSSVM_ENABLE_OPENMP_BACKEND=OFF -DPLSSVM_ENABLE_SYCL_BACKEND=ON -DPLSSVM_ENABLE_CUDA_BACKEND=OFF -DPLSSVM_ENABLE_HIP_BACKEND=OFF -DPLSSVM_ENABLE_OPENCL_BACKEND=OFF -S ../../ &&\
                                        make -j4 "
                                    '''
                                }
                            }
                        }
                        stage('hipSYCL - Release - test') {
                            steps {
                                dir('plssvm') {
                                    warnError('hipSYCL Release tests failed!') {
                                        sh '''
                                            srun -w argon-gtx -N 1 -n 1 -t 01:00:00 -D /scratch/jenkins/plssvm/${BUILD_TAG}/PLSSVM --gres=gpu:4 bash -c "\
                                            module load cuda/11.2.2 &&\
                                            cd build/Release_hipSYCL &&\
                                            ctest --output-on-failure -j4 --no-compress-output -T Test --timeout 3600; \
                                            returncode=$? && \
                                            cp -r Testing /data/argon-fs/sgs/jenkins/workspace/$(basename ${WORKSPACE})/${BUILD_TAG}/Testing_hip && \
                                            exit $returncode"
                                        '''
                                    }
                                }
                            }
                        }
                    }
                } // end hipSYCL Release

                stage('DPC++ - Release') {
                    environment {
                        PATH="/data/argon-fs/sgs/jenkins/workspace/PLSSVM_Github-Multi-GPU_jenkins/cmake-3.24.1-linux-x86_64/bin:/data/sgs/jenkins/workspace/PLSSVM_Github-Multi-GPU_jenkins/cmake-3.24.1-linux-x86_64/bin:$DPCPP_PATH/bin:${env.PATH}"
                        LIBRARY_PATH="$DPCPP_PATH/lib:${env.LIBRARY_PATH}"
                        LD_LIBRARY_PATH="$DPCPP_PATH/lib:${env.LD_LIBRARY_PATH}"
                        CPLUS_INCLUDE_PATH="$DPCPP_PATH/install/include/sycl:$DPCPP_PATH/install/include:$DPCPP_PATH/projects/openmp/runtime/src:${env.CPLUS_INCLUDE_PATH}"
                    }
                    stages {
                        stage('DPC++ - Release - build') {
                            steps {
                                dir('plssvm') {
                                    sh '''
                                        srun -w argon-gtx -N 1 -n 1 -t 00:25:00 -D /scratch/jenkins/plssvm/${BUILD_TAG}/PLSSVM bash -c "\
                                        module load cuda/11.2.2 &&\
                                        mkdir -p build/Release_DPCPP &&\
                                        cd build/Release_DPCPP &&\
                                        rm -rf * &&\
                                        cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_CXX_COMPILER=clang++ -DPLSSVM_TARGET_PLATFORMS='nvidia:sm_61' -DPLSSVM_ENABLE_ASSERTS=ON -DPLSSVM_ENABLE_OPENMP_BACKEND=OFF -DPLSSVM_ENABLE_CUDA_BACKEND=OFF -DPLSSVM_ENABLE_OPENCL_BACKEND=OFF -DPLSSVM_ENABLE_SYCL_BACKEND=ON  -DPLSSVM_SYCL_BACKEND_PREFERRED_IMPLEMENTATION=dpcpp -DPLSSVM_ENABLE_LTO=OFF -S ../../ &&\
                                        make -j4 "
                                    '''
                                }
                            }
                        }
                        stage('DPC++ - Release - test') {
                            steps {
                                dir('plssvm') {
                                    warnError('DPC++ Release tests failed!') {
                                        sh '''
                                            srun -w argon-gtx -N 1 -n 1 -t 01:00:00 -D /scratch/jenkins/plssvm/${BUILD_TAG}/PLSSVM --gres=gpu:4 bash -c "\
                                            module load cuda/11.2.2 &&\
                                            cd build/Release_DPCPP &&\
                                            ctest --output-on-failure -j4 --no-compress-output -T Test --timeout 3600; \
                                            returncode=$? && \
                                            cp -r Testing /data/argon-fs/sgs/jenkins/workspace/$(basename ${WORKSPACE})/${BUILD_TAG}/Testing_dpcpp &&\
                                            exit $returncode"
                                        '''
                                    }
                                }
                            }
                        }
                    }
                } // end DPC++ Release

            } // end parallel
        } // end Multi-GPU
    }

    post {
        always {
            // Process the CTest xml output with the xUnit plugin
            xunit (
                testTimeMargin: '3000',
                thresholdMode: 1,
                thresholds: [
                    failed(failureThreshold: '0')
                ],
                tools: [CTest(
                    pattern: '${BUILD_TAG}/Testing*/**/*.xml',
                    deleteOutputFiles: true,
                    failIfNotNew: false,
                    skipNoTestFiles: true,
                    stopProcessingIfError: true
                )]
            )
            sh '''
                srun -w argon-gtx -n 1 -t 00:05:00 bash -c "rm -rf /data/scratch/jenkins/plssvm/${BUILD_TAG}"
                rm -rf ${BUILD_TAG}
            '''
        }
        success {
            script {
                buildbadge.setStatus('success')
            }
            sh '''
                gitlab_token=$(echo ${GITHUB_TOKEN} | cut -f2 -d':')
                curl --verbose\
                     --request POST \
                     --url "https://api.github.com/repos/SC-SGS/PLSSVM/statuses/$GIT_COMMIT" \
                     --header "Content-Type: application/json" \
                     --header "authorization: Bearer ${gitlab_token}" \
                     --data "{
                        \\"state\\": \\"success\\",
                        \\"context\\": \\"Jenkins Multi-GPU tests\\",
                        \\"description\\": \\"Jenkins CI Job: Jenkins Multi-GPU tests\\",
                        \\"target_url\\": \\"https://simsgs.informatik.uni-stuttgart.de/jenkins/view/PLSSVM/job/PLSSVM/job/Github-Multi-GPU/job/${BRANCH_NAME}/$BUILD_NUMBER\\"
                }"
            '''
        }
        failure {
            script {
                buildbadge.setStatus('failing')
            }
            sh '''
                gitlab_token=$(echo ${GITHUB_TOKEN} | cut -f2 -d':')
                curl --verbose\
                     --request POST \
                     --url "https://api.github.com/repos/SC-SGS/PLSSVM/statuses/$GIT_COMMIT" \
                     --header "Content-Type: application/json" \
                     --header "authorization: Bearer ${gitlab_token}" \
                     --data "{
                        \\"state\\": \\"failure\\",
                        \\"context\\": \\"Jenkins Multi-GPU tests\\",
                        \\"description\\": \\"Jenkins CI Job: Jenkins Multi-GPU tests\\",
                        \\"target_url\\": \\"https://simsgs.informatik.uni-stuttgart.de/jenkins/view/PLSSVM/job/PLSSVM/job/Github-Multi-GPU/job/${BRANCH_NAME}/$BUILD_NUMBER\\"
                }"
            '''
        }
        aborted {
            script {
                buildbadge.setStatus('aborted')
            }
            sh '''
                gitlab_token=$(echo ${GITHUB_TOKEN} | cut -f2 -d':')
                curl --verbose\
                     --request POST \
                     --url "https://api.github.com/repos/SC-SGS/PLSSVM/statuses/$GIT_COMMIT" \
                     --header "Content-Type: application/json" \
                     --header "authorization: Bearer ${gitlab_token}" \
                     --data "{
                        \\"state\\": \\"error\\",
                        \\"context\\": \\"Jenkins Multi-GPU tests\\",
                        \\"description\\": \\"Jenkins CI Job: Jenkins Multi-GPU tests\\",
                        \\"target_url\\": \\"https://simsgs.informatik.uni-stuttgart.de/jenkins/view/PLSSVM/job/PLSSVM/job/Github-Multi-GPU/job/${BRANCH_NAME}/$BUILD_NUMBER\\"
                }"
            '''
        }
    }
}
